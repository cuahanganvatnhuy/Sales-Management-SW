<!-- Sidebar Navigation Component -->
<style>
/* Simple submenu styles with high specificity */
.sidebar ul li .submenu {
    display: none !important;
    list-style: none;
    padding: 0;
    margin: 8px 0 0 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1000;
}

.sidebar ul li .submenu.show {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.sidebar ul li .submenu li {
    margin: 0;
    padding: 0;
    list-style: none;
}
span.titlle {
    font-size: 30px;
    margin: 0 auto;
    font-family: fantasy;
}
.sidebar ul li .submenu a {
    display: block !important;
    padding: 12px 20px 12px 40px;
    color: rgba(255, 255, 255, 0.9) !important;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
    background: transparent;
    width: 100%;
    box-sizing: border-box;
}

.sidebar ul li .submenu a:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    border-left-color: #4CAF50;
    color: #fff !important;
}

.sidebar ul li .submenu a i {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

.submenu-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

/* Order submenu styles */
.order-submenu {
    display: none;
    list-style: none;
    padding: 0;
    margin: 8px 0 0 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.order-submenu.show {
    display: block;
}

.order-submenu-item {
    margin: 0;
    padding: 0;
    list-style: none;
}

.order-submenu-link {
    display: block;
    padding: 12px 20px 12px 40px;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    font-size: 14px;
    border-left: 3px solid transparent;
    cursor: pointer;
}

.order-submenu-link:hover {
    background: rgba(255, 255, 255, 0.1);
    border-left-color: #4CAF50;
    color: #fff;
}

.order-submenu-icon {
    margin-right: 8px;
    width: 16px;
    text-align: center;
}

.submenu-chevron {
    margin-left: auto;
    font-size: 12px;
}
</style>
<nav class="sidebar">
    <div class="sidebar-header">
        <div class="logo" style="text-align: center; margin-top: 15px;">
            <span class="titlle">Business Management</span> <br>
            <span class="">Phúc Hoàng Technology</span>
        </div>
    </div>
    <ul class="sidebar-menu">
        <li id="nav-home"><a href="/index.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li class="has-submenu" data-permission="product_read">
            <a href="#" onclick="toggleProductSubmenu(event)">
                <i class="fas fa-box"></i>
                <span>Sản Phẩm</span>
                <i class="fas fa-chevron-down submenu-chevron"></i>
            </a>
            <ul id="productSubmenu" class="order-submenu">
                <li class="order-submenu-item" data-permission="product_create">
                    <a href="/view/products.html" data-page="products.html" class="order-submenu-link">
                        <i class="fas fa-plus order-submenu-icon"></i>
                        Thêm Sản Phẩm
                    </a>
                </li>
                <li class="order-submenu-item" data-permission="product_read">
                    <a href="/view/product-management.html" data-page="product-management.html" class="order-submenu-link">
                        <i class="fas fa-list order-submenu-icon"></i>
                        Quản Lý Sản Phẩm
                    </a>
                </li>
                <li class="order-submenu-item" data-permission="product_category_manage">
                    <a href="/view/product-categories.html" data-page="product-categories.html" class="order-submenu-link">
                        <i class="fas fa-tags order-submenu-icon"></i>
                        Danh Mục Sản Phẩm
                    </a>
                </li>
            </ul>
        </li>
        <li id="nav-selling-products" data-permission="selling_product_manage">
            <a href="/view/selling-products.html" data-page="selling-products.html">
                <i class="fas fa-money-bill-wave"></i>
                <span>Quản Lý Sản Phẩm Bán</span>
            </a>
        </li>
        <li class="has-submenu">
            <a href="#" class="nav-link" onclick="toggleOrderSubmenu(event)">
                <i class="fas fa-plus-circle"></i>
                <span>Tạo Đơn Hàng</span>
                <i class="fas fa-chevron-down submenu-chevron"></i>
            </a>
            <ul id="orderSubmenu" class="order-submenu">
                <li class="order-submenu-item">
                    <a href="/view/orders.html" data-page="orders.html" class="order-submenu-link">
                        <i class="fas fa-shopping-cart order-submenu-icon"></i>
                        Đơn Hàng TMĐT
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/retail-orders.html" data-page="retail-orders.html" class="order-submenu-link">
                        <i class="fas fa-store order-submenu-icon"></i>
                        Đơn Hàng Bán Lẻ
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/wholesale-orders.html" data-page="wholesale-orders.html" class="order-submenu-link">
                        <i class="fas fa-warehouse order-submenu-icon"></i>
                        Đơn Hàng Bán Sỉ
                    </a>
                </li>
            </ul>
        </li>
        <li class="has-submenu">
            <a href="#" class="nav-link" onclick="toggleSalesOrderSubmenu(event)">
                <i class="fas fa-shopping-bag"></i>
                <span>Đơn Hàng Bán</span>
                <i class="fas fa-chevron-down submenu-chevron"></i>
            </a>
            <ul id="salesOrderSubmenu" class="order-submenu">
                <li class="order-submenu-item">
                    <a href="/view/sales-orders-tmdt.html" data-page="sales-orders-tmdt.html" class="order-submenu-link">
                        <i class="fas fa-shopping-cart order-submenu-icon"></i>
                        TMĐT Bán
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/sales-orders-retail.html" data-page="sales-orders-retail.html" class="order-submenu-link">
                        <i class="fas fa-store order-submenu-icon"></i>
                        Bán Lẻ
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/sales-orders-wholesale.html" data-page="sales-orders-wholesale.html" class="order-submenu-link">
                        <i class="fas fa-warehouse order-submenu-icon"></i>
                        Bán Sỉ
                    </a>
                </li>
            </ul>
        </li>
        <li id="nav-order-management">
            <a href="/view/order-management.html" data-page="order-management.html">
                <i class="fas fa-tasks"></i>
                <span>Quản Lý Đơn Hàng</span>
            </a>
        </li>
        <li id="nav-sales-order-management">
            <a href="/view/sales-order-management.html" data-page="sales-order-management.html">
                <i class="fas fa-chart-line"></i>
                <span>Quản Lý Đơn Hàng Bán</span>
            </a>
        </li>
        <li id="nav-profit-management" class="has-submenu">
            <a href="#" class="nav-link" onclick="toggleProfitSubmenu(event)">
                <i class="fas fa-coins"></i>
                <span>Quản Lý Lợi Nhuận</span>
                <i class="fas fa-chevron-down submenu-chevron"></i>
            </a>
            <ul id="profitSubmenu" class="order-submenu">
                <li class="order-submenu-item">
                    <a href="/view/overview-profit.html" data-page="overview-profit.html" class="order-submenu-link">
                        <i class="fas fa-chart-pie order-submenu-icon"></i>
                        Tổng Quan Lợi Nhuận
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/profit-management.html" data-page="profit-management.html" class="order-submenu-link">
                        <i class="fas fa-shopping-cart order-submenu-icon"></i>
                        Lợi Nhuận Đơn TMĐT
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/retail-profit.html" data-page="retail-profit.html" class="order-submenu-link">
                        <i class="fas fa-store order-submenu-icon"></i>
                        Lợi Nhuận Đơn Lẻ
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/wholesale-profit.html" data-page="wholesale-profit.html" class="order-submenu-link">
                        <i class="fas fa-warehouse order-submenu-icon"></i>
                        Lợi Nhuận Đơn Sỉ
                    </a>
                </li>
            </ul>
        </li>
        <li id="nav-stores" data-permission="store_read"><a href="/view/stores.html" data-page="stores.html"><i class="fas fa-store"></i> <span>Cửa Hàng</span></a></li>
        <li id="nav-user-management" data-permission="user_read"><a href="/view/user-management.html" data-page="user-management.html"><i class="fas fa-users"></i> <span>Quản Lý Người Dùng</span></a></li>
        <li id="nav-reports" data-permission="report_read"><a href="/view/reports.html" data-page="reports.html"><i class="fas fa-chart-bar"></i> <span>Báo Cáo</span></a></li>
        <li id="nav-warehouse" data-permission="warehouse_read"><a href="/view/warehouse-management.html" data-page="warehouse-management.html"><i class="fas fa-warehouse"></i> <span>Quản Lý Kho</span></a></li>
        <li id="nav-shipping-cost" data-permission="shipping_read"><a href="/view/shipping-cost-management.html" data-page="shipping-cost-management.html"><i class="fas fa-shipping-fast"></i> <span>Chi Phí Vận Chuyển</span></a></li>
        <li class="has-submenu">
            <script>
                // Immediate fallback - ensure function is available right away
                if (!window.navigateToInvoice) {
                    window.navigateToInvoice = function(type) {
                        console.log('=== NAVIGATION DEBUG ===');
                        console.log('Type:', type);
                        console.log('Current URL:', window.location.href);
                        console.log('Current pathname:', window.location.pathname);
                        
                        const currentPath = window.location.pathname;
                        const isInRoot = currentPath === '/' || currentPath.endsWith('/index.html') || currentPath.includes('/index.html');
                        
                        console.log('Is in root?', isInRoot);
                        
                        let targetUrl;
                        if (type === 'global') {
                            targetUrl = isInRoot ? 'view/global-invoice.html' : 'global-invoice.html';
                        } else {
                            targetUrl = isInRoot ? 'view/store-invoice.html' : 'store-invoice.html';
                        }
                        
                        console.log('Target URL:', targetUrl);
                        console.log('Full target URL:', window.location.origin + '/' + targetUrl);
                        console.log('About to navigate...');
                        
                        window.location.href = targetUrl;
                    };
                    console.log('navigateToInvoice function registered from immediate fallback');
                }
            </script>
            <a href="#" class="nav-link" onclick="toggleSubmenu(event)">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Quản Lý Hóa Đơn</span>
                <i class="fas fa-chevron-down submenu-chevron"></i>
            </a>
            <ul id="invoiceSubmenu" class="order-submenu">
                <li class="order-submenu-item">
                    <a href="#" onclick="event.preventDefault(); navigateToInvoice('global'); return false;" class="order-submenu-link">
                        <i class="fas fa-globe order-submenu-icon"></i>
                        Hóa Đơn Toàn Bộ
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="#" onclick="event.preventDefault(); navigateToInvoice('store'); return false;" class="order-submenu-link">
                        <i class="fas fa-store order-submenu-icon"></i>
                        Hóa Đơn Từng Cửa Hàng TMĐT
                    </a>
                </li>
                <li class="order-submenu-item">
                    <a href="/view/invoice-payment.html" data-page="invoice-payment.html" class="order-submenu-link">
                        <i class="fas fa-credit-card order-submenu-icon"></i>
                        Hóa Đơn Thanh Toán
                    </a>
                </li>
            </ul>
        </li>
        <li id="nav-settings"><a href="/view/settings.html" data-page="settings.html"><i class="fas fa-cog"></i> <span>Cài Đặt</span></a></li>
    </ul>

    <script>
        // Global submenu toggle function - works on all pages
        window.toggleSubmenu = function(event) {
            event.preventDefault();
            const submenu = document.getElementById('invoiceSubmenu');
            if (submenu) {
                submenu.classList.toggle('show');
                console.log('Invoice submenu toggled');
            }
        };
        
        // Order submenu toggle function - Define immediately
        if (typeof window.toggleOrderSubmenu === 'undefined') {
            window.toggleOrderSubmenu = function(event) {
                event.preventDefault();
                const submenu = document.getElementById('orderSubmenu');
                if (submenu) {
                    submenu.classList.toggle('show');
                    window.updateOrderTypeUI();
                    console.log('Order submenu toggled');
                } else {
                    console.log('Order submenu not found!');
                }
            };
            console.log('✅ toggleOrderSubmenu function defined');
        }
        
        // Product submenu toggle function - Define immediately
        if (typeof window.toggleProductSubmenu === 'undefined') {
            window.toggleProductSubmenu = function(event) {
                event.preventDefault();
                const submenu = document.getElementById('productSubmenu');
                if (submenu) {
                    submenu.classList.toggle('show');
                    console.log('Product submenu toggled');
                } else {
                    console.log('Product submenu not found!');
                }
            };
            console.log('✅ toggleProductSubmenu function defined');
        }
        
        // Sales order submenu toggle function - Define immediately
        if (typeof window.toggleSalesOrderSubmenu === 'undefined') {
            window.toggleSalesOrderSubmenu = function(event) {
                event.preventDefault();
                const submenu = document.getElementById('salesOrderSubmenu');
                if (submenu) {
                    submenu.classList.toggle('show');
                    console.log('Sales order submenu toggled');
                } else {
                    console.log('Sales order submenu not found!');
                }
            };
            console.log('✅ toggleSalesOrderSubmenu function defined');
        }
        
        // Profit submenu toggle function - Define immediately
        if (typeof window.toggleProfitSubmenu === 'undefined') {
            window.toggleProfitSubmenu = function(event) {
                event.preventDefault();
                const submenu = document.getElementById('profitSubmenu');
                if (submenu) {
                    submenu.classList.toggle('show');
                    console.log('Profit submenu toggled');
                } else {
                    console.log('Profit submenu not found!');
                }
            };
            console.log('✅ toggleProfitSubmenu function defined');
        }
        
        // Permission-based menu visibility
        function updateMenuVisibility() {
            console.log('🔍 Updating menu visibility based on permissions...');
            
            // Check if authSystem is available
            if (typeof window.authSystem === 'undefined') {
                console.log('⚠️ AuthSystem not available, showing all menus');
                return;
            }
            
            // Get all menu items with data-permission attribute
            const menuItems = document.querySelectorAll('[data-permission]');
            
            menuItems.forEach(item => {
                const requiredPermission = item.getAttribute('data-permission');
                const hasPermission = window.authSystem.hasPermission(requiredPermission);
                
                const itemText = item.textContent.trim().substring(0, 30);
                console.log(`🔍 Menu: "${itemText}", Permission: ${requiredPermission}, Access: ${hasPermission}`);
                
                if (hasPermission) {
                    item.style.display = '';
                    item.classList.remove('hidden');
                } else {
                    item.style.display = 'none';
                    item.classList.add('hidden');
                }
            });
            
            // Check if parent menus should be hidden (if all children are hidden)
            const parentMenus = document.querySelectorAll('.has-submenu');
            parentMenus.forEach(parentMenu => {
                const submenu = parentMenu.querySelector('.order-submenu');
                if (submenu) {
                    const visibleChildren = submenu.querySelectorAll('.order-submenu-item:not([style*="display: none"]):not(.hidden)');
                    
                    if (visibleChildren.length === 0) {
                        parentMenu.style.display = 'none';
                        parentMenu.classList.add('hidden');
                        console.log(`🚫 Hiding parent menu: ${parentMenu.textContent.trim()} (no visible children)`);
                    } else {
                        parentMenu.style.display = '';
                        parentMenu.classList.remove('hidden');
                    }
                }
            });
            
            console.log('✅ Menu visibility update completed');
        }
        
        // Export function globally
        window.updateMenuVisibility = updateMenuVisibility;

        
        // Dynamic link adjustment based on current path
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const isInRoot = currentPath === '/' || currentPath.endsWith('/index.html') || currentPath.includes('/index.html');
            
            // Get all navigation links
            const navLinks = document.querySelectorAll('.sidebar a[data-page]');
            
            navLinks.forEach(link => {
                const page = link.getAttribute('data-page');
                if (page && !link.href.includes('#')) {
                    if (isInRoot) {
                        // From root (dashboard), add 'view/' prefix
                        link.href = 'view/' + page;
                    } else {
                        // From view/ pages, use relative path
                        link.href = page;
                    }
                }
            });
            
            // Update menu visibility based on permissions
            setTimeout(() => {
                updateMenuVisibility();
            }, 1000);
            
            // Close submenu when clicking outside
            document.addEventListener('click', function(e) {
                const invoiceSubmenu = document.getElementById('invoiceSubmenu');
                const orderSubmenu = document.getElementById('orderSubmenu');
                const productSubmenu = document.getElementById('productSubmenu');
                const salesOrderSubmenu = document.getElementById('salesOrderSubmenu');
                const profitSubmenu = document.getElementById('profitSubmenu');
                const hasSubmenu = e.target.closest('.has-submenu');
                
                if (invoiceSubmenu && !hasSubmenu) {
                    invoiceSubmenu.classList.remove('show');
                    console.log('Invoice submenu closed by clicking outside');
                }
                
                if (orderSubmenu && !hasSubmenu) {
                    orderSubmenu.classList.remove('show');
                    console.log('Order submenu closed by clicking outside');
                }
                
                if (productSubmenu && !hasSubmenu) {
                    productSubmenu.classList.remove('show');
                    console.log('Product submenu closed by clicking outside');
                }
                
                if (salesOrderSubmenu && !hasSubmenu) {
                    salesOrderSubmenu.classList.remove('show');
                    console.log('Sales order submenu closed by clicking outside');
                }
                
                if (profitSubmenu && !hasSubmenu) {
                    profitSubmenu.classList.remove('show');
                    console.log('Profit submenu closed by clicking outside');
                }
            });
        });
    </script>
</nav>